<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jukebox Player</title>

  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    #playerBox {
      width: 100vw;
      height: 56.25vw;
      max-height: 100vh;
      max-width: 177.78vh;
      margin: auto;
    }
    #player { width: 100%; height: 100%; }
    #status {
      padding: 10px 14px;
      font-size: 14px;
      opacity: .85;
    }
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    #overlay button {
      font-size: 22px;
      padding: 14px 18px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="playerBox"><div id="player"></div></div>
  <div id="status">Loading…</div>

  <div id="overlay">
    <button id="startBtn">Tap to Start</button>
  </div>

  <!-- YouTube IFrame API -->
  <script>
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  </script>

  <!-- Firebase (compat SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyBNcetbvYsxDVAAezn0GdxVaLeW7j2EoO4",
      authDomain: "jukebox-queue-f62c7.firebaseapp.com",
      databaseURL: "https://jukebox-queue-f62c7-default-rtdb.firebaseio.com",
      projectId: "jukebox-queue-f62c7",
      storageBucket: "jukebox-queue-f62c7.firebasestorage.app",
      messagingSenderId: "288785705112",
      appId: "1:288785705112:web:1e721031fc856d056ac8ed"
    };
    
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ROOM = (location.hash || "#default").replace("#", "");
console.log("[player] ROOM =", ROOM);
console.log("[player] queue path =", `rooms/${ROOM}/queue`);


    
    const queueRef = db.ref(`rooms/${ROOM}/queue`);
    const nowPlayingRef = db.ref(`rooms/${ROOM}/nowPlaying`);

    const statusEl = document.getElementById("status");
    const overlay = document.getElementById("overlay");
    const startBtn = document.getElementById("startBtn");

    let player, ready = false, playing = false;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    async function popNext() {
      const snap = await queueRef.orderByChild("addedAt").limitToFirst(1).get();
      if (!snap.exists()) return null;

      const key = Object.keys(snap.val())[0];
      const item = snap.val()[key];
      await queueRef.child(key).remove();
      return item;
    }

    async function playNext() {
      if (!ready) return;

      const next = await popNext();
      if (!next) {
        playing = false;
        setStatus("Queue empty 1.1 — waiting…");
        return;
      }

      playing = true;
      
const vid = next.videoId || next.youtubeId;
setStatus(`Now playing 1.1: ${next.title || vid || "Unknown"}`);

if (!vid) {
  console.warn("[player] Missing video id on item:", next);
  setStatus("Queue item missing video id — waiting…");
  playing = false;
  return;
}

player.loadVideoById(vid);


      setTimeout(() => {
        try {
          if (player.getPlayerState() !== YT.PlayerState.PLAYING) {
            overlay.style.display = "flex";
          }
        } catch {
          overlay.style.display = "flex";
        }
      }, 1200);
    }

    startBtn.onclick = () => {
      overlay.style.display = "none";
      try {
        player.playVideo();
        player.unMute();
      } catch {}
    };

    window.onYouTubeIframeAPIReady = function() {
      player = new YT.Player("player", {
        playerVars: { autoplay: 1, controls: 1, rel: 0 },
        events: {
          onReady: async () => {
            ready = true;
            setStatus("Ready — waiting for queue");
            await playNext();
          },
          onStateChange: async (e) => {
            if (e.data === YT.PlayerState.PLAYING) overlay.style.display = "none";
            if (e.data === YT.PlayerState.ENDED) await playNext();
          },
          onError: async () => {
            setStatus("Video error — skipping");
            await playNext();
          }
        }
      });
    };

    queueRef.on("child_added", async () => {
      if (!playing) await playNext();
    });
  </script>
</body>
</html>

